{% extends 'base.html' %}

{% block title %}Buyurtma #{{ order.id }} - Restaurant Pro{% endblock %}
{% block page_title %}Buyurtma #{{ order.id }}{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
    <!-- Buyurtma qismi -->
    <div style="background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px;">
            <div>
                <h1 style="margin-bottom: 5px;">Buyurtma #{{ order.id }}</h1>
                <div style="color: #666;">
                    {% if table %}
                    ü™ë Stol {{ table.number }} ‚Ä¢ {{ table.seats }} kishi
                    {% else %}
                    {{ order.get_order_type_display }}
                    {% endif %}
                    ‚Ä¢ {{ order.created_at|date:"H:i d/m/Y" }}
                </div>
            </div>
            <div style="background: {% if order.is_completed %}var(--success){% else %}var(--warning){% endif %}; color: white; padding: 8px 16px; border-radius: var(--border-radius); font-weight: 600;">
                {% if order.is_completed %}‚úÖ Bajarildi{% else %}üîÑ Jarayonda{% endif %}
            </div>
        </div>
        
        <!-- Taomlar qo'shish -->
        <h3 style="margin-bottom: 20px;">Taom qo'shish</h3>
        <form method="post" style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; margin-bottom: 30px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_item">
            
            <select name="dish_id" class="form-control" required>
                <option value="">Taomni tanlang</option>
                {% for dish in dishes %}
                <option value="{{ dish.id }}" {% if dish.portions == 0 %}disabled style="color: #ccc;"{% endif %}>
                    {{ dish.name }} - {{ dish.price }} so'm {% if dish.portions == 0 %}(Portiya yo'q){% endif %}
                </option>
                {% endfor %}
            </select>
            
            <input type="number" name="quantity" value="1" min="1" class="form-control" required>
            
            <button type="submit" class="btn btn-primary">Qo'shish</button>
        </form>
        
        <!-- Buyurtma ro'yxati -->
        <h3 style="margin-bottom: 20px;">Buyurtma ro'yxati</h3>
        
        {% if order_items %}
        <div class="table">
            <div class="table-header">
                <div>Taom</div>
                <div>Narx</div>
                <div>Soni</div>
                <div>Summa</div>
                <div>Amallar</div>
            </div>
            
            {% for item in order_items %}
            <div class="table-row">
                <div>
                    <strong>{{ item.dish.name }}</strong>
                    {% if item.dish.portions < item.quantity %}
                    <div style="color: var(--danger); font-size: 0.8rem;">‚ö†Ô∏è Portiya yetarli emas</div>
                    {% endif %}
                </div>
                <div>{{ item.dish.price }} so'm</div>
                <div>
                    <form method="post" style="display: flex; gap: 5px; align-items: center;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_quantity">
                        <input type="hidden" name="order_item_id" value="{{ item.id }}">
                        <input type="number" name="quantity" value="{{ item.quantity }}" min="1" style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="submit" class="btn" style="padding: 5px 8px; background: var(--info); color: white;">üîÑ</button>
                    </form>
                </div>
                <div><strong>{{ item.total }} so'm</strong></div>
                <div class="action-buttons">
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="remove_item">
                        <input type="hidden" name="order_item_id" value="{{ item.id }}">
                        <button type="submit" class="btn" style="background: var(--danger); color: white; padding: 5px 8px;">üóëÔ∏è</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #666; background: var(--light); border-radius: var(--border-radius);">
            <div style="font-size: 3rem; margin-bottom: 15px;">üçΩÔ∏è</div>
            <h4>Hozircha buyurtmalar yo'q</h4>
            <p>Yuqoridan taom qo'shing</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Hisob-kitob qismi -->
    <div style="background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); height: fit-content;">
        <h3 style="margin-bottom: 20px;">Hisob-kitob</h3>
        
        <div style="display: flex; justify-content: between; margin-bottom: 15px;">
            <span>Jami:</span>
            <span><strong>{{ subtotal }} so'm</strong></span>
        </div>
        
        <div style="display: flex; justify-content: between; margin-bottom: 15px; color: #666;">
            <span>Xizmat xaqqi (10%):</span>
            <span>{{ service_fee|floatformat:2 }} so'm</span>
        </div>
        
        <hr style="margin: 20px 0; border: none; border-top: 2px solid var(--light);">
        
        <div style="display: flex; justify-content: between; margin-bottom: 25px; font-size: 1.2rem; font-weight: 700;">
            <span>Umumiy summa:</span>
            <span style="color: var(--success);">{{ total_with_service|floatformat:2 }} so'm</span>
        </div>
        
        {% if not order.is_completed %}
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="complete_order">
            <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                ‚úÖ Buyurtmani yakunlash
            </button>
        </form>
        {% endif %}
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <a href="{% if table %}{% url 'tables' %}{% else %}{% url 'orders' %}{% endif %}" class="btn" style="background: var(--light); color: var(--dark); flex: 1; text-align: center;">
                ‚Üê Orqaga
            </a>
        </div>
    </div>
</div>
{% endblock %}